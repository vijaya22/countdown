name: Publish to Chrome Web Store

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create ZIP
        run: zip -r countdown.zip manifest.json newtab.html newtab.js styles.css constants.js content.js background.js assets/ lib/

      - name: Upload and Publish to Chrome Web Store
        env:
          CHROME_CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
          CHROME_CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
          CHROME_REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}
          CHROME_EXTENSION_ID: dbpmgoghpheaeldmfgifedhjbdookjbo
        run: |
          set -euo pipefail

          TOKEN_RESPONSE=$(curl -sS -X POST https://oauth2.googleapis.com/token \
            -d "client_id=${CHROME_CLIENT_ID}" \
            -d "client_secret=${CHROME_CLIENT_SECRET}" \
            -d "refresh_token=${CHROME_REFRESH_TOKEN}" \
            -d "grant_type=refresh_token")
          ACCESS_TOKEN=$(echo "${TOKEN_RESPONSE}" | jq -r '.access_token // empty')

          if [ -z "${ACCESS_TOKEN}" ]; then
            echo "Failed to fetch OAuth token."
            echo "${TOKEN_RESPONSE}"
            exit 1
          fi

          UPLOAD_RESPONSE=$(curl -sS -X PUT \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "x-goog-api-version: 2" \
            -H "Content-Type: application/zip" \
            --data-binary @countdown.zip \
            "https://www.googleapis.com/upload/chromewebstore/v1.1/items/${CHROME_EXTENSION_ID}")
          echo "Upload response:"
          echo "${UPLOAD_RESPONSE}"

          if echo "${UPLOAD_RESPONSE}" | jq -e '.error' >/dev/null; then
            echo "Upload API returned an error."
            exit 1
          fi

          UPLOAD_STATE=$(echo "${UPLOAD_RESPONSE}" | jq -r '.uploadState // empty')
          if [ "${UPLOAD_STATE}" != "SUCCESS" ]; then
            echo "Unexpected upload state: ${UPLOAD_STATE}"
            exit 1
          fi

          PUBLISH_RESPONSE=$(curl -sS -X POST \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "x-goog-api-version: 2" \
            "https://www.googleapis.com/chromewebstore/v1.1/items/${CHROME_EXTENSION_ID}/publish?publishTarget=default&projection=DRAFT")
          echo "Publish response:"
          echo "${PUBLISH_RESPONSE}"

          if echo "${PUBLISH_RESPONSE}" | jq -e '.error' >/dev/null; then
            echo "Publish API returned an error."
            exit 1
          fi

          ITEM_STATUS_RESPONSE=$(curl -sS \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "x-goog-api-version: 2" \
            "https://www.googleapis.com/chromewebstore/v1.1/items/${CHROME_EXTENSION_ID}?projection=DRAFT")
          echo "Item status response:"
          echo "${ITEM_STATUS_RESPONSE}"
